#!/bin/bash
set -e -x
if [ -n "$TLS_DOMAIN" ]
then
  TLS_DOMAINS=$TLS_DOMAIN
fi

if [ -n "$TLS_DOMAINS" ]
then
  FIRST_DOMAIN=$(echo $TLS_DOMAINS | cut -f 1 -d ' ')
  OPTS=""
  for DOMAIN in $TLS_DOMAINS
  do
    OPTS="$OPTS -d $DOMAIN"
  done
  
  CMD="certbot certonly --noninteractive --standalone $OPTS --agree-tos --email $TLS_EMAIL"
  if [ -f /etc/letsencrypt/$FIRST_DOMAIN.cmd ]
  then
    LAST_CMD=$(cat /etc/letsencrypt/$FIRST_DOMAIN.cmd) 
    if [ "$LAST_CMD" != "$CMD" ]
    then
      rm -rf /etc/letsencrypt/archive/$FIRST_DOMAIN
      rm -rf /etc/letsencrypt/live/$FIRST_DOMAIN
    fi
  else 
    rm -rf /etc/letsencrypt/archive/$FIRST_DOMAIN
    rm -rf /etc/letsencrypt/live/$FIRST_DOMAIN
  fi
  
  if [ -d /etc/letsencrypt/archive/$FIRST_DOMAIN ] 
  then
    certbot renew
  else
    $CMD
    echo -n "$CMD" > /etc/letsencrypt/$FIRST_DOMAIN.cmd
  fi

fi

exec /etc/init.d/nginx start
